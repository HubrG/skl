{% extends 'base.html.twig' %}


{% if category.slug is defined %}
{% set slugCat = category.slug %}
{% set slugCatName = category.name %}
{% else %}
{% set slugCat = "all" %}
{% set slugCatName = "Tous les récits" %}
{% endif %}


{% block title %}Récits | {{ slugCatName }} — {{ parent() }}

{% endblock %}

{% block body %}
<section class="col-span-12 mb-10">
	<h1 class="text-center font-serif">{{ slugCatName }}</h1>
</section>
{# ! Séparateur de mots clés dans l'URL & page #}
{% set separator = "—" %}
{% set separator_d = "——" %} <!-- double séparateur -->
{% set pageAct = app.request.get('_route_params')['page'] %}
<turbo-frame id="pagination-{{ random(0,999) }}" class="grid col-span-full gap-x-10 container -mt-5" >
<aside class=" items-center justify-items-between content-center flex-row row-span-2 sticky top-40 snap-y h-18 ">
{# 
! On affiche les keywords utilisés 
#}
{% if kwString %}
<p class="text-center text-md"><a href="{{ path("app_publication_show_all_category", {slug:slugCat, page:1, order:orderSort}) }}" class="text-slate-600 font-semibold">Réinitialiser</a></p>
<hr class="my-2">
	{% set n = 0 %}
	{% set alreadyKeyw = [] %}
	{% set kwStringSplit = kwString|split(separator) %}
	{# * début de la boucle #}
	{% for item in pubShowSave %}
		{% set item2replace = item.keyword|lower %}
		{# * Si le keyword n'est pas dans alreadyKeyw (qui permet de détecter les doublons), et que le keyword est dans l'url, et que le keyword est dans le tableau kwStringSplit (mise en tableau afin d'éviter les confusions "Quis" "Quisa" "Quima" avec des simples replace...) #}
		{% if (item.keyword not in alreadyKeyw) and (item2replace in kwString == true) and (item2replace in kwStringSplit) %} 
			{# * on crée la nouvelle string #}
			{% set kwStringNew = "" %}
			{% for i, item in kwStringSplit %}
				{% if item|lower != item2replace %}
					{% set kwStringNew = kwStringNew ~ separator ~ item %}		
				{% endif %}
			{% endfor %}
			{# Si le premier caractère est un séparateur, on le supprime #}
			{% if kwStringNew|slice(0,1) == separator %}
				{% set kwStringNew = kwStringNew|slice(1,9999) %}
			{% endif %}
			{# Si le dernier caractère est un séparateur, on le supprime #}
			{% set var = kwStringNew|length - 1 %}
			{% if kwStringNew|slice(var,1) == separator %}
				{% set kwStringNew = kwStringNew|slice(0,var) %}
			{% endif %}
			{# * affichage des keywords #}
			<a href="{{ path("app_publication_show_all_category", {slug:slugCat, keystring:kwStringNew, page:1, order:orderSort}) }}" class=" bg-slate-300 rounded justify-items-between mb-1 text-center hover:text-slate-800 grid  text-slate-700 text-sm font-medium ">
				<span class="mr-2 leading-[1.7rem]  dark:bg-blue-900 dark:text-blue-300">{{item.keyword}}
				<i class="fa-solid fa-delete-left float-right mt-2"></i></span> 
			</a>
		{% endif %}
		{% set alreadyKeyw = alreadyKeyw|merge([item.keyword]) %}
		{% set n = n + 1 %}
	{% endfor %}
{% endif %}
{# 
! On affiche les keywords non utilisés 
#}
{% set n = 0 %}
{% set alreadyKeyw = [] %}
{# * début de la boucle #}
{% for item in pubShowSave %} 
	{# * S'il n'y a aucun keyword dans la string, alors on ne met pas le séparateur #}
	{% set kwAdd = separator ~ item.keyword|lower %}
	{% if kwString|length == 0 %}
		{% set kwAdd = item.keyword|lower %}
	{% endif %}
	{# * On affiche les keywords avec le bon lien #} 
	{% if (item.keyword not in alreadyKeyw) and (item.keyword|lower in kwString == false) %} <!-- Si le keyword n'est pas dans la variable, on le supprime (éviter les doublons) -->
	{% set kwString = kwString|replace({separator_d:separator}) %}
	<a href="{{ path("app_publication_show_all_category", {slug:slugCat, keystring:kwString ~ kwAdd, order:orderSort, page:1}) }}">
		<span class="bg-slate-100 text-slate-600 text-sm font-medium mr-2 px-2.5 py-0.5 leading-10 rounded dark:bg-blue-900 dark:text-blue-300">{{item.keyword}}</span> 
	</a>
	{% endif %}
{% set n = n + 1 %}
{% set alreadyKeyw = alreadyKeyw|merge([item.keyword]) %}
{% endfor %}
</aside>
{# 
! Affichage des récits
#}
<section class="col-span-10 -mt-5  contrast-100 hue-rotate-15 grayscale" style="--animate-duration: 1s;">
	<div class="flex mb-10 justify-center gap-7">
		<h4 class="w-4/6 mb-5 font-light text-lg text-slate-500">{{ count }} récits</h4>
		<div class="-mt-3 -ml-2 items-end">
			<button id="sortButton" data-dropdown-toggle="sortHover" data-dropdown-trigger="hover" class="text-white bg-blue-400 hover:bg-blue-500 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex  dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
				Trier par <svg class="w-4 h-4 ml-2" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
			</button>
			<!-- Dropdown menu -->
			<div id="sortHover" class="z-10 hidden bg-white divide-y divide-slate-100 rounded-lg shadow w-auto dark:bg-slate-700">
				<ul class="py-2 text-sm text-slate-700 dark:text-slate-200" aria-labelledby="sortButton">
				<li>
					<a href="{{ path("app_publication_show_all_category", {slug:slugCat, keystring:kwString, page:page, order:"desc"}) }}" class="block px-4 py-2 hover:text-slate-700 {% if orderSort == "desc" %} bg-slate-100 hover:bg-slate-100{% else %} hover:bg-slate-50{% endif %} dark:hover:bg-slate-600 dark:hover:text-white">Récits les plus <strong>récents</strong> d'abord</a>
				</li>
				<li>
					<a href="{{ path("app_publication_show_all_category", {slug:slugCat, keystring:kwString, page:page, order:"asc"}) }}" class="block px-4 py-2 hover:text-slate-700 {% if orderSort == "asc" %} bg-slate-100  hover:bg-slate-100{% else %} hover:bg-slate-50{% endif %}  dark:hover:bg-slate-600 dark:hover:text-white">Récits les plus <strong>anciens</strong> d'abord</a>
				</li>
				
				</ul>
				<div class="py-2">
	  <a href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 dark:text-slate-200 dark:hover:text-white">Separated link</a>
	</div>
			</div>


		</div>
		<div class="-mt-3 -mr-5">
			{% if countPage > 1 %}
				{% include "publication/_show_pagination.html.twig" with {'type': "top"}  %}
			{% endif %}
		</div>
	</div>
	<div class=" flex-col grid-cols-2 gap-3 grid row-span-full  items-stretch animate__animated animate__fadeIn" >
		{% for item in pubShow %}
		<div class=" rounded-lg   dark:border-slate-700 flex place-content-start">
			<div class="w-2/6  h-auto rounded-lg">
				<a href="{{ path("app_publication_show_one", {id:item.id, slug:item.slug, page:1}) }}">
					<img class="rounded object-cover w-full shaow-md lazy animate-pulse animate__animated bg-slate-300"  loading="lazy" src="" data-src="{{ "https://picsum.photos/400/" ~ random(500, 520) }}" alt="" />
				</a>
			</div>
			<div class="p-5 -mt-6 w-4/6 place-content-baseline items-baseline">
				<h5 class="mb-2 text-base font-bold tracking-tight ">
					<a href="{{ path("app_publication_show_one", {id:item.id, slug:item.slug, page:1}) }}" class=" text-slate-700  dark:text-white ">{{ item.title }}</a>
				</h5>
				<p  class="text-xs -mt-2 mb-2 text-slate-500 font-base">{{ item.publicationChapters|chapter("nbr", "ft") }} | {{ item.publicationChapters|chapter("rt", "ft") }} de lecture</p>
				<p class="mb-3 font-normal text-slate-800 text-sm text-justify  dark:text-slate-400">
					{{ item.summary|slice(0, 210) }}
					<br />
					<span class="text-xs">
				</p>
				<p class=" text-cyan-600"> 
					{% for pubKeyw in item.publicationKeywords %}
					<span class="bg-slate-100 text-slate-600 text-xs font-medium mr-1 leading-7 mb-2 px-2.5 py-0.5 rounded dark:bg-slate-700 dark:text-slate-400 ">{{ pubKeyw.keyword|lower }}{% if not loop.last %}{% endif %}</span>
					{% endfor %}
				</p>
				</div>
		</div>
		{% endfor %}
	</div>
</section>
<div class="col-span-12  pt-20 flex justify-center">
{% if countPage > 1 %}
{% include "publication/_show_pagination.html.twig" with {'type': "bottom"}  %}
{% endif %}
</div>
</turbo-frame>
{% endblock %}
