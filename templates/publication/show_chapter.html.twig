{% extends 'base.html.twig' %}

{% block title %}
	{{ infoPub.title ~ ' (' ~ infoChap.title ~ ')' }}
	-
	{{ parent() }}
{% endblock %}
{% block body %}
	<section id="titleChapter">
		<div>
			<h1>
				<a id="chapTitle" href="{{ path("app_publication_show_one", {id:infoPub.id, slug:infoPub.slug}) }}">{{ infoPub.title }}</a>
			</h1>
			<h2>
				<small>par</small>
				<span class="font-medium">
					<a href="{{ path("app_user", {username:infoPub.user.username}) }}">{{ infoPub.user.nickname }}</a>
				</span>
			</h2>
		</div>
		<div class="items-center justify-center justify-items-center flex">
			<a href="{{ path("app_user", {username:infoPub.user.username}) }}" class=" text-xl text-slate-700">{{ infoChap.title }}</a>
		</div>
	</section>
	<section class="col-span-8 col-start-3 pt-10 row-start-2" id="chapContent">
		{% if previousChap %}
			<div class="fixed top-0 w-10 bottom-0 left-0 flex items-center justify-start  ml-8 lg:ml-56 z-10" id="arrowPrevious">
				<a href="{{ path("app_chapter_show", {idChap:previousChap.id, slugPub:infoPub.slug, user:infoPub.user.username, slug:previousChap.slug}) }}" class="text-slate-600">
					<i class="fa-solid fa-angles-left text-4xl"></i>
				</a>
			</div>
		{% endif %}
		<turbo-frame id="chapContentTurbo">
			<article class="flex flex-col justify-center" id="chapArticle">
				{{ chapterContent|raw }}
			</article>
		</turbo-frame>
		{% if nextChap %}
			<div class="fixed top-0 bottom-0 right-0 flex items-center justify-end mr-8 lg:mr-56  z-10" id="arrowNext">
				<a href="{{ path("app_chapter_show", {idChap:nextChap.id, slugPub:infoPub.slug, user:infoPub.user.username, slug:nextChap.slug}) }}" class="text-slate-600">
					<i class="fa-solid fa-angles-right  text-4xl"></i>
				</a>
			</div>
		{% endif %}
		<div class="mt-10" id="bottomChap">
			{% if previousChap %}
				<p class="float-left">
					<a href="{{ path("app_chapter_show", {idChap:previousChap.id, slugPub:infoPub.slug, user:infoPub.user.username, slug:previousChap.slug}) }}">
						<i class="fa-solid fa-angles-left"></i>
						Chapitre précédent</a>
				</p>
			{% endif %}
			{% if nextChap %}
				<p class="float-right">
					<a href="{{ path("app_chapter_show", {idChap:nextChap.id, slugPub:infoPub.slug, user:infoPub.user.username, slug:nextChap.slug}) }}">Chapitre suivant
						<i class="fa-solid fa-angles-right"></i>
					</a>
				</p>
			{% endif %}
		</div>
	</section>
	{# TODO: ajouter temps de lecture restant dans le chapitre + temps de lecture total de la publication #}
	<section class="col-span-8 col-start-3  mt-5 w-full row-start-3">
		<hr class="mb-5"/>
		<h3 class="text-2xl font-medium">Commentaires</h3>

		{% if app.user.id is defined %}
			{{ form_start(form, {attr:{"data-turbo-frame":"commentFrame"}}) }}
			<div class="flex items-center">
				{{ form_widget(form.content, {attr:{"class":"h-[3.4rem] items-center content-center pt-3"}}) }}
				<button type="submit" class="btn btn-primary h-12" id="sendComment">Envoyer</button>
			</div>
			{{ form_end(form) }}
		{% endif %}
		<hr>
		<turbo-frame id="commentFrame">
			<p>{{ infoChap.publicationChapterComments|length }}
				commentaire(s)<br/><br/>
			</p>
			{% set n = 0 %}
			{% if app.user.id is defined %}
				{% set userLogId = app.user.id %}
			{% else %}
				{% set userLogId = null %}
			{% endif %}
			{% for item in comments|sort((a, b) => a.publishDate > b.publishDate ? -1 : 1) %}
				{% if item.user.id is defined %}
					<div {% if n == 0 and userLogId == item.user.id and item.publishDate > "now"|date_modify("-2 seconds") %} id="lastComment" class="bg-slate-50 text-slate-600  animate__animated animate__fadeIn p-2 rounded transition-colors duration-[1000ms]" {% else %} class=" block  p-2 rounded" {% endif %}>
						<p class=" text-lg">
							<small>il y a
								{{ item.publishDate|since }}
								par
								<a href="{{ path("app_user", {username:item.user.username}) }}">{{ item.user.nickname }}</a>
								{% if item.user.id == userLogId %}
									|
									<a data-turbo-frame="_self" href="{{ path("app_chapter_del_comment", {id:item.id}) }}">Supprimer</a>
									|
									<button type="button" class="updateButton" id="updateButton-{{ item.id }}">Modifier</button>
									{% set class = "fa-regular fa-heart " %}
								{% elseif userLogId %}
									{% set class = "fa-regular fa-heart likeButton cursor-pointer" %}
								{% else %}
									{% set class = "fa-regular fa-heart " %}
								{% endif %}
								|
								{% for itemLike in item.publicationChapterCommentLikes %}
									{% if itemLike.user.id == userLogId %}
										{% set class = "fa-solid fa-heart text-red-500 cursor-pointer likeButton" %}
									{% else %}
										{% set class = "fa-regular fa-heart" %}
									{% endif %}
								{% endfor %}
								<i class="{{ class }} animate__animated" id="likeButton-{{ item.id }}"></i>
								<span id="nbLikes-{{ item.id }}">{{ item.publicationChapterCommentLikes|length }}</span>
							</small>
						</p>
						<div id="updateCom-{{ item.id }}">
							<p id="comShow-{{ item.id }}">{{ item.content|nl2br }}</p>
						</div>
					</div>
					{% set n = n + 1 %}
				{% endif %}
			{% endfor %}
			{% if nbrShowCom < infoChap.publicationChapterComments|length %}
				{% if infoPub.slug %}
					{% set chapterSlug = infoPub.slug %}
				{% else %}
					{% set chapterSlug = "feuille-n0" ~ (chapter.orderDisplay + 1) %}
				{% endif %}
				<a href="{{path("app_chapter_show", {user:infoPub.user.id, slug:chapterSlug, slugPub:infoPub.slug, idChap:infoChap.id, nbrShowCom:nbrShowCom + 10})}}">Afficher plus de commentaires</a>
			{% endif %}
		</turbo-frame>
	</section>
	<div id="tools" class="hidden">
		<ul>
			<li class="hl" data-color="1">
				<i class="fa-solid fa-bookmark text-emerald-200"></i>
			</li>
			<li class="hl" data-color="2">
				<i class="fa-solid fa-bookmark text-amber-200"></i>
			</li>
			<li class="hl" data-color="3">
				<i class="fa-solid fa-bookmark text-red-200"></i>
			</li>
			<li class="hl" data-color="4">
				<i class="fa-solid fa-bookmark text-slate-200"></i>
			</li>
			<li class="text-slate-400">|</li>
			<li class="commentQuote" data-drawer-target="drawer-right-example" data-drawer-show="drawer-right-example" data-drawer-placement="right" aria-controls="drawer-right-example">
				<i data-tippy-content="Commenter ce passage" class="fa-regular fa-comment"></i>
			</li>
			<li>
				<i class="fa-solid fa-lock"></i>
			</li>
			<li>|</li>
			<li>
				<i data-tippy-content="Partager sur Twitter" class="shareTwitter  fa-brands fa-square-twitter text-[#1DA1F2]  text-xl"></i>
			</li>
			<li>
				<i data-tippy-content="Partager sur Facebook" class="shareFb fa-brands fa-square-facebook text-[#3b5998]  text-xl"></i>
			</li>
			<li>
				<i data-tippy-content="Partager sur Linkedin" class="shareLk fa-brands fa-linkedin text-[#0072b1] text-xl"></i>
			</li>
			<li>
				<i data-tippy-content="Copier la sélection" class="fa-solid fa-link text-slate-700"></i>
			</li>
		</ul>
	</div>
	<div id="highlighted-options" class="hidden">
		<ul>
			<li>
				<div id="delete-hl">
					<i data-tippy-content="Supprimer le marquage" class="fa-solid fa-xmark"></i>
				</div>
			</li>
			<li class="text-slate-400">|</li>
			<li class="commentQuote" data-drawer-target="drawer-right-example" data-drawer-show="drawer-right-example" data-drawer-placement="right" aria-controls="drawer-right-example">
				<i data-tippy-content="Commenter ce passage" class="fa-regular fa-comment"></i>
			</li>
			<li>
				<i class="fa-solid fa-lock"></i>
			</li>
			<li class="text-slate-400">|</li>
			<li>
				<i data-tippy-content="Partager sur Twitter" class="shareTwitter  fa-brands fa-square-twitter text-[#1DA1F2]  text-xl cursor-pointer"></i>
			</li>
			<li>
				<i data-tippy-content="Partager sur Facebook" class="shareFb fa-brands fa-square-facebook text-[#3b5998]  text-xl"></i>
			</li>
			<li>
				<i data-tippy-content="Partager sur Linkedin" class="shareLk fa-brands fa-linkedin text-[#0072b1] text-xl"></i>
			</li>
			<li>
				<i data-tippy-content="Copier la sélection" class="fa-solid fa-link text-slate-700"></i>
			</li>
		</ul>
	</div>
	{% include "publication/_partials/_show_drawer.html.twig" with {'type': "bottom"}  %}
	<input type="hidden" id="chapId" value="{{ infoChap.id }}">
{% endblock %}
