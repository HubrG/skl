{% extends "base.html.twig" %}

{% block title %}
	Récit |
	{{ pubShow.title }}
	-
	{{ parent() }}
{% endblock %}

{% set summary %}
{% if pubShow.summary|length > 2 %}
	{{ pubShow.summary|slice(0, 250) ~ "..." }}
{% else %}
	{% set nbr = 0 %}
	{% for chapter in chapShow %}
		{% if chapter.status > 1 and nbr == 0 %}
			{{ chapter.content|regex_replace('/<p.*?>/i', ' ')|striptags|slice(0, 250) ~ "..." }}
			{% set nbr = nbr + 1 %}
		{% endif %}
	{% endfor %}
{% endif %}
{% endset %}
{% block metatags %}
	<meta name="description" content="{{ summary|trim }}">
	<meta name="author" content="{{ pubShow.user.nickname }}">
{% endblock %}
{% block body %}
	{% set pic = pubShow.cover %}
	{% if pic %}
		{% else %}
			{% set pic = " https://picsum.photos/200/" ~ random(300, 310) %}
	{% endif %}
	<style>
		#test
		{
			position: inherit;
			z-index: 1;
		}
		#test::before
		{
			content: "";
			position: absolute;
			display: inline;
			top: 0;
			left: 0;
			right: 0;
			width: 100%;
			min-height: 100vh;
			height: 150vh;
			opacity: .1;
			z-index: -99999999999;
			background-image: url('{{ pic }}');
			background-position: center;
		}
	</style>
	<section class=" before:bg-cover before:blur before:-z-[9999]  col-span-12 col-start-0 md:col-span-10 md:col-start-2 gap-10" id="test">
		<h1 class="text-center font-serif text-4xl bg-center text-slate-800" style="text-shadow: 0 0.5px 1px blanchedalmond;">{{ pubShow.title }}</h1>
		<h2 class="text-center -mt-8">
			<span class="font-medium font-serif">
				<a href="{{ path("app_user", {username:pubShow.user.username}) }}" class="font-sans hover:underline">{{ pubShow.user.nickname }}</a>
			</span>
		</h2>
		<div class="flex justify-center">
			<img class=" rounded-full mt-6 object-cover w-40 h-40 justify-center  mb-5  pb-1 shaow-md  grayscale-[50%]" src="{{pic}}" alt=""/>
		</div>
		<div class="flex gap-5 p-10 pt-0  items-center">
			<div class="flex-1 text-center flex flex-col justify-center items-center justify-items-center origin-center">
				<div class="md:flex w-5/6">
					<p class="text-base font-serif text-justify italic text-slate-900 leading-7 mt-1">
						{% if orderChap %}
							{% if pubShow.summary %}
								<span class="material-symbols-outlined">
									format_quote
								</span>&nbsp;
								{{ pubShow.summary }}... &nbsp;&nbsp;
								<div class="mt-5"></div>
							{% endif %}
						{% else %}
							<center>
								<i class="fa-solid fa-hourglass-half text-4xl font-thin text-slate-600"></i>
							</center>
							<br><span class="text-xl text-slate-500">Récit en cours de rédaction, aucune feuille pour le moment...</span>
						{% endif %}
					</p>
				</div>
				<a href="{{ path("app_chapter_show", {idChap:orderChap.id, slugPub:pubShow.slug, user:pubShow.user.username, slug:orderChap.slug}) }}" class=" block mt-5 not-italic py-5 text-center w-full lg:w-3/6 px-10 bg-white bg-opacity-70 hover:bg-white text-slate-900 shadow hover:text-slate-900 hover:bg-opacity-100 rounded-lg">
					<span class="material-symbols-outlined">
						local_library
					</span>
					<br/><span class="font-medium">Commencer la lecture</span>
				</a>
				<a target="_top" href="{{ path("app_publication_show_one", {id:pubShow.id, slug:"download"}) }}" class=" block mt-5 not-italic  text-center text-sm px-5  hover:underline text-slate-900 ">
					<span class="material-symbols-outlined">
						download
					</span>
					<span class="font-medium">
						Télécharger au format pdf</span>
				</a>
			</div>
		</div>
	</section>
	{% if orderChap %}
		<section class="md:flex col-span-12 md:col-span-10 md:col-start-2  mt-6 justify-evenly min-h-[50vh] z-50">
			<div class="absolute bg-white w-full min-h-[100%] left-0 right-0 -z-10  border-t-[1px] border-slate-200">&nbsp;</div>
			<div class="w-full lg:w-7/12 pt-10 z-50 order-2 lg:order-1 ">
				<h3 class="text-2xl mb-5 lg:text-left text-center">
					<span class="material-symbols-outlined">
						format_list_bulleted
					</span>
					&nbsp;
					{% set count = 0 %}
					{% for chapter in pubShow.publicationChapters %}
						{% if chapter.status == 2 %}
							{% set count = count + 1 %}
						{% endif %}
					{% endfor %}
					{{ count > 1 ? count ~ " feuilles" : count ~ " feuille"}}</h3>
				<ul class="flex flex-col">
					{% set nbrPages = 0 %}
					{% set chapterStats = {'likes': 0, 'bookmarks': 0, 'views': 0, 'comments': 0, 'pages': 0} %}
					{% for chapter in chapShow %}
						{% if chapter.status > 1 %}
							{% set chapterSlug = chapter.slug ?: "feuille-n0" ~ (chapter.orderDisplay + 1) %}
							<li class="inline-flex items-center gap-x-2 py-1 px-4 text-base font-medium text-slate-900 -mt-px dark:bg-gray-800 dark:text-white">
								<div class="flex justify-between w-full">
									<a href="{{ path("app_chapter_show", {idChap:chapter.id, slugPub:pubShow.slug, user:pubShow.user.username, slug:chapterSlug}) }}" class="h-full w-4/6 font-normal text-slate-900 text-lg hover:underline">
										<span class="font-bold">{{ loop.index }}.</span>
										{{ chapter.title|default("Feuille n°" ~ (chapter.orderDisplay + 1))|capitalize }}
									</a>
									<div class="w-2/6 justify-items-end opacity-80">
										<div class="py-1 px-2 rounded-full flex justify-between text-xs text-slate-600 font-medium">
											<div>
												<span class="material-symbols-outlined">
													favorite
												</span>
												{{ chapter.publicationChapterLikes|length }}
												{% set chapterStats = chapterStats|merge({'likes': chapterStats.likes + chapter.publicationChapterLikes|length}) %}
											</div>
											<div>
												<span class="material-symbols-outlined">
													bookmarks
												</span>
												{{ chapter.publicationChapterBookmarks|length }}
												{% set chapterStats = chapterStats|merge({'bookmarks': chapterStats.bookmarks + chapter.publicationChapterBookmarks|length}) %}
											</div>
											<div>
												<span class="material-symbols-outlined">
													visibility
												</span>
												{{ chapter.publicationChapterViews|length }}
												{% set chapterStats = chapterStats|merge({'views': chapterStats.views + chapter.publicationChapterViews|length}) %}
											</div>
											<div>
												<span class="material-symbols-outlined">
													forum
												</span>
												{{ chapter.publicationChapterComments|length }}
												{% set chapterStats = chapterStats|merge({'comments': chapterStats.comments + chapter.publicationChapterComments|length}) %}
											</div>
										</div>
										{% set chapterStats = chapterStats|merge({'pages': chapterStats.pages + chapter.content|readInfo("nbr_page_A4")}) %}
									</div>
								</div>
							</li>
						{% endif %}
					{% endfor %}
				</ul>
			</div>
			<div class="w-full  z-50 mt-5 pt-5 px-2 md:w-4/12  order-1 lg:order-2  shadow-slate-300 text-slate-900 border-slate-200 border-t-[1px] border-t-slate-200 lg:border-l-[1px] lg:border-t-0 ">
				<ul class="opacity-60 flex flex-col  text-sm">
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								theater_comedy
							</span>
							&nbsp;&nbsp;Genre
						</span>
						<a href="{{path("app_publication_show_all_category", {slug:pubShow.category.slug})}}" class="catColor-{{pubShow.category.color}} rounded px-2 py-1 text-xs">
							<span>{{ pubShow.category.name }}</span>
						</a>
					</li>
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								auto_stories
							</span>
							&nbsp;&nbsp;Nombre de pages (pdf)
						</span>
						<span>{{ chapterStats.pages }}</span>
					</li>
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								timer
							</span>
							&nbsp;&nbsp;Temps de lecture
						</span>
						<span>{{ pubShow.publicationChapters|chapter("rt", "ft") }}</span>
					</li>
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								visibility
							</span>
							&nbsp;&nbsp;Nombre de lecteurs
						</span>
						<span>{{chapterStats.views}}</span>
					</li>
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								forum
							</span>
							&nbsp;Commentaires
						</span>
						<span>
							{% if chapterStats.comments > 0 %}
								{{chapterStats.comments}}
							{% else %}
								Aucun
							{% endif %}
						</span>
					</li>
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								book
							</span>
							&nbsp;&nbsp;&nbsp;Pages marquées
						</span>
						<span>{{chapterStats.bookmarks}}</span>
					</li>
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								favorite
							</span>
							&nbsp;&nbsp;&nbsp;J'aime
						</span>
						<span>{{chapterStats.likes}}</span>
					</li>
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								downloading
							</span>
							&nbsp;&nbsp;&nbsp;Téléchargements
						</span>
						<span>{{pubShow.PublicationDownloads|length}}</span>
					</li>
					{# Progression #}
					{% set popularityChange = 0 %}
					{% if pubShow.PublicationPopularities|length > 1 %}
						{% set lastPopularity = pubShow.PublicationPopularities[1].popularity %}
						{% set currentPopularity = pubShow.PublicationPopularities[0].popularity %}
						{% set popularityChange = currentPopularity - lastPopularity %}
					{% endif %}

					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px dark:bg-gray-800 dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								insights
							</span>
							&nbsp;&nbsp;&nbsp;Popularité
							<span class="font-light text-xs">(7 jours)</span>
						</span>
						<span>
							{% if popularityChange > 0 %}
								<span class="material-icons  text-red-700">
									arrow_circle_down
								</span>
							{% elseif popularityChange == 0 %}
								<span class="material-symbols-outlined">
									equal
								</span>
							{% else %}
								<span class="material-icons text-green-700">
									arrow_circle_up
								</span>
							{% endif %}
						</span>
					</li>
				</ul>
				<ul class=" flex flex-col  text-sm border-t-[1px] border-t-slate-200 pt-5 mt-5">
					<li class="inline-flex items-center justify-between gap-x-2 font-medium py-1 px-4 -mt-px  dark:bg-gray-800  dark:text-white">
						{% for item in pubShow.publicationKeywords %}
							<a href="{{path("app_publication_show_all_category", {keystring:item.keyword|lower, order:'desc', sortby:'published', page:1, slug:"all"})}}" class="hover:underline text-slate-800">#{{ item.keyword }}</a>
						{% endfor %}
					</li>
				</ul>
				<ul class=" flex flex-col opacity-60 text-sm border-t-[1px] border-t-slate-200 pt-5 mt-5">
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								newspaper
							</span>
							&nbsp;&nbsp;Publié depuis
						</span>
						<span>{{ pubShow.publishedDate|since }}</span>
					</li>
					<li class="inline-flex items-center justify-between gap-x-2 py-2 px-4 font-normal -mt-px  dark:bg-gray-800  dark:text-white">
						<span class="font-medium">
							<span class="material-symbols-outlined">
								auto_fix
							</span>
							&nbsp;&nbsp;Modifié il y a
						</span>
						<span>{{ pubShow.updated|since }}</span>
					</li>
				</ul>
			</div>
		</section>
	{% endif %}
{% endblock %}
