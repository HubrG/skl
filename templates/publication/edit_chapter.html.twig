{% extends 'base.html.twig' %}

{% block title %}
	Édition |
	{{ infoPub.title|capitalize }}
	({{ infoChap.title|capitalize }}
	)
{% endblock %}

{% block meta %}{% endblock %}
{% block stylesheets %}
	<link href="//cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">
{% endblock %}
{% block javascripts %}{% endblock %}
{% block body %}
	<nav class="breadcrumb" aria-label="Breadcrumb">
		<ol>
			<li>
				<a href="{{path("app_user_show_publications")}}">
					Mes récits
				</a>
			</li>
			<li>
				<i class="fa-duotone fa-angle-right"></i>
				{% if infoPub.publicationChapters|length < 2 %}
					{% set var = "#first" %}
				{% else %}
					{% set var = "" %}
				{% endif %}
				<a href="{{path("app_publication_edit", {id:infoPub.id})}}{{var}}">
					{% set titleChar = infoPub.title|length %}
					{% if titleChar > 15 %}
						<span data-tippy-content="{{infoPub.title}}">{{ infoPub.title|capitalize|slice(0,15) ~ "..." }}</span>
					{% else %}
						{{ infoPub.title|capitalize }}
					{% endif %}
				</a>&nbsp;&nbsp;

				{% if (infoPub.status > 1) %}
					<span class="flex w-3 h-3 bg-green-500 rounded-full"></span>
				{% else %}
					<span class="flex w-3 h-3 bg-red-500 rounded-full"></span>
				{% endif %}
			</li>
			<li aria-current="page">
				<i class="fa-duotone fa-angle-right"></i>
				<div id="ddt">
					<div class="flex items-center">
						<div id="dropdownDatabase" data-dropdown-toggle="dropdown-database" class="text-slate-500 dark:text-slate-400 cursor-pointer">
							Édition d'une feuille
							<svg class="w-5 h-5 ml-1" aria-hidden="true" fill="currentColor" viewbox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
								<path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
							</svg>
						</div>
						<ul id="dropdown-database" class="z-10  bg-white hidden overflow-y-auto max-h-[70vh] divide-y  divide-gray-100 rounded-lg shadow dark:shadow-2xl w-80 dark:bg-slate-700  transform translate-y-2">
							<ul class="relative text-sm flex flex-col py-4 pt-0 text-gray-700 dark:text-gray-200" aria-labelledby="dropdownDefault">
								<li class="dark:bg-slate-900 bg-slate-50 shadow text-center sticky top-0">
									<span class="block w-full px-4 py-2 font-semibold dark:text-red-500 text-md ">
										<i class="fa-duotone fa-eye"></i>&nbsp;&nbsp;Feuilles publiées
									</span>
								</li>
								<ul class="my-2">
									{% set n = 0 %}
									{% for item in chaps %}
										{% if item.status == 2 %}
											{% if item.id == infoChap.id %}
												<li class="w-full">
													<span class="block w-full px-4 py-2 font-semibold italic dark:hover:text-white ">{{item.title}}
														&nbsp;&nbsp;<small>— feuille actuelle</small>
													</span>
												</li>
											{% else %}
												<li class="w-full">
													<a href="{{ path("app_publication_edit_chapter", { idPub:infoPub.id, idChap:item.id }) }}" target="_top" class="block w-full px-4 py-2 font-semibold dark:hover:text-white ">{{item.title}}</a>
												</li>
											{% endif %}
											{% set n = n + 1 %}
										{% endif %}
									{% endfor %}

								</ul>
								{% if n == 0 %}
									<li class="flex justify-center items-center my-5 italic opacity-70 text-xs">
										<span>Aucune feuille publiée</span>
									</li>
								{% endif %}
								<li class=" sticky top-0 dark:bg-slate-900 bg-slate-50 shadow border-t-[1px] dark:border-t-slate-700 border-t-slate-100 text-center">
									<span class="block w-full px-4 py-2 font-semibold dark:text-red-500  text-md ">
										<i class="fa-duotone fa-eye"></i>&nbsp;&nbsp;Feuilles dépubliées
									</span>
								</li>
								<ul class="my-2">
									{% set n = 0 %}
									{% for item in chaps %}
										{% if item.status == 1 %}
											{% if item.id == infoChap.id %}
												<li class="w-full">
													<span class="block w-full px-4 py-2 font-semibold italic dark:hover:text-white ">{{item.title}}
														&nbsp;&nbsp;<small>— feuille actuelle</small>
													</span>
												</li>
											{% else %}
												<li class="w-full">
													<a href="{{ path("app_publication_edit_chapter", { idPub:infoPub.id, idChap:item.id }) }}" target="_top" class="block w-full px-4 py-2 font-semibold dark:hover:text-white ">{{item.title}}</a>
												</li>
											{% endif %}
											{% set n = n + 1 %}
										{% endif %}
									{% endfor %}
								</ul>
								{% if n == 0 %}
									<li class="flex justify-center items-center my-5 italic opacity-70 text-xs">
										<span>Aucune feuille dépubliée</span>
									</li>
								{% endif %}
							</ul>
						</ul>
					</div>
				</div>
			</li>
			<li>
				<div role="status" id="spinAS" class="hidden flex  flex-row  items-centers">
					<i class="fa-duotone fa-angle-right mt-1"></i>
					<span class="flex flex-row  items-centers">
						<i class="fa-duotone fa-spinner fa-spin align-middle leading-[inherit] dark:[--fa-secondary-color:#1E293B] [--fa-secondary-color:#fff]" style="--fa-primary-color: #16da47; "></i>
						<span class=" text-slate-400">Enregistrement...</span>
					</span>
				</div>
			</li>
		</ol>
	</nav>
	<section class="col-start-0 lg:col-start-2 ">
		<div class="relative mb-5 md:mb-0">
			<div class="items-baseline pb-10 relative grid grid-cols-12 auto-rows-auto">
				<input type="text" id="title" name="title" class="dark:bg-transparent dark:text-slate-200 col-span-12 lg:col-span-8  order-2 lg:order-1 active:caret-none focus:ring-0  font-normal text-slate-600 text-4xl overflow-hidden h-16 [font-family:'Merriweather'] mt-0 lg:mt-10 border-0  mb-0 pb-0 border-b-2 border-b-slate-600 dark:border-b-slate-600 {% if (infoPub.status < 2 or infoChap.status < 2) %}axiosChapterAS{% endif %} axiosSpy" value="{{ infoChap.title }}" placeholder="Titre de la feuille">
				<div class=" col-span-12 lg:col-span-4 order-1 lg:order-2 pt-5 lg:pt-0 mb-5 lg:mb-0 sm:mt-5 justify-center lg:justify-end  flex">
					<button type="button" class="button-classic button-emerald" id="saveChapter">
						{% if (infoPub.status < 2 or infoChap.status < 2) %}
							<i class="fa-regular fa-floppy-disk"></i>
							&nbsp;Enregistrer
						{% else %}
							<i class="fa-regular fa-cloud-arrow-up"></i>&nbsp;Publier les modifications
						{% endif %}
					</button>
					<button class="button-classic button-slate ml-2 font-bold" id="ddChapterOptionsButton" data-dropdown-toggle="ddChapterOptions" data-dropdown-delay="1500">
						<i class="fa-regular fa-ellipsis-vertical mx-2"></i>
					</button>
				</div>
			</div>
		</div>
		<div id="button-selector" style="display: none; position: absolute;" data-tippy-content="Importer une photo" class=" bg-slate-700 p-2 py-1 rounded-full opacity-80 hover:opacity-100 text-slate-50  text-xs -mt-16 -ml-0 md:-mt-8 md:-ml-10 md:text-base cursor-pointer z-50">
			<label for="add-img-chapter" class="cursor-pointer">
				<div type="button" id="add-image-button">
					<i class="fa-solid fa-image"></i>
				</div>
			</label>
			<input type="file" id="add-img-chapter" name="add-img" accept="image/*" style="display: none;">
		</div>
		<div id="editor" name="content" data-turbo="false" class="w-full  {% if (infoPub.status < 2 or infoChap.status < 2) %}axiosChapterAS{% endif %} axiosSpy"></div>
		<input type="hidden" id="editorHTML" value="{{ infoChap.content }}">
		<div class="mt-3">
			<p class="text-slate-500 text-sm flex gap-x-5 justify-between md:justify-start">
				<span class="flex text-center flex-col md:flex-row justify-center items-center gap-x-2">
					<i class="fa-regular fa-timer"></i>
					<span id="readTime">
						{{ infoChap.content|readInfo("ri_mn_ft_short") }}
						et
						{{ infoChap.content|readInfo("ri_sc_ft_short") }}
						de lecture
					</span>
				</span>
				<span class="flex text-center flex-col md:flex-row justify-center items-center gap-x-2">
					<i class="fa-regular fa-text-size"></i>
					<span id="wordCount">
						{% set ri_wc = infoChap.content|readInfo("ri_wc") %}
						{{ ri_wc }}
						{% if ri_wc > 1 %}mots{% else %}mot
						{% endif %}
					</span>
				</span>
				<span class="flex text-center flex-col md:flex-row justify-center items-center gap-x-2">
					<i class="fa-regular fa-i-cursor"></i>
					<span id="signCount">
						{% set ri_cc = infoChap.content|readInfo("ri_cc") %}
						{{ ri_cc }}
						{% if ri_cc > 1 %}signes{% else %}signe
						{% endif %}
					</span>
				</span>
				<span class="flex text-center flex-col md:flex-row justify-center items-center gap-x-2">
					<i class="fa-regular fa-paragraph"></i>
					<span id="paragraphCount">
						{% set ri_pc = infoChap.content|readInfo("ri_pc") %}
						{{ ri_pc }}
						{% if ri_pc > 1 %}paragraphes{% else %}paragraphe
						{% endif %}
					</span>
				</span>
			</p>
		</div>
	</section><!-- Dropdown menu --><div id="ddChapterOptions" class="z-20 hidden w-full max-w-sm bg-white divide-y divide-gray-100 rounded-lg shadow-xl dark:bg-gray-800 dark:divide-gray-700" aria-labelledby="ddChapterOptionsButton">
		<div class="divide-y divide-gray-100 dark:divide-gray-700">
			<div class="p-4 rounded-t-lg">
				<label class="relative inline-flex items-center cursor-pointer">
					<input id="togglePublish" type="checkbox" class="sr-only peer" {% if infoChap.status > 1 %} checked {% endif %}/>
					<div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
					<span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">
						{% if infoChap.status > 1 %}Dépublier la feuille
							{% else %}Publier la feuille
						{% endif %}
					</span>
				</label>
			</div>
			<div class="p-4 ">
				{% if (infoPub.status < 2 or infoChap.status < 2) %}
					{% set checked_or_disable = "checked" %}
				{% else %}
					{% set checked_or_disable = "disabled" %}
				{% endif %}
				<label class="relative inline-flex items-center {{ checked_or_disable == 'disabled' ? " cursor-not-allowed opacity-60" : " cursor-pointer"}}" id="asTip">
					<input id="toggleAS" type="checkbox" class="sr-only peer " {{ checked_or_disable }}/>
					<div class=" w-11 h-6 bg-gray-200 disabled:bg-red-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
					<span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300 ">
						Enregistrement automatique
					</span>
					{{ checked_or_disable == "disabled" ? '&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa-duotone fa-comment-question" data-tippy-content="La sauvegarde automatique est désactivée. Votre récit est pulié, et cette feuille aussi ! Vous pouvez cependant cliquer sur le bouton vert « Publier les modification » pour mettre à jour cette feuille."></i>' }}
				</label>

			</div>
			<div class="p-4 pt-0  bg-slate-50 dark:bg-transparent">
				<p class="p-4 pb-0 font-semibold text-center text-slate-700 dark:text-slate-200">Charger une autre version</p>
				<div class=" justify-end items-baseline flex ">
					<div class="relative mr-2" id="selectChapVersionContainer">
						<div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none mt-5">
							<i class="fa-regular fa-code-compare"></i>
						</div>
						<select name="status" class="select" id="selectChapVersion">
							{% set myVal = 0 %}
							{% for items in infoChap.publicationChapterVersionings|sort((a, b) => b.created <=> a.created) %}
								{% set myVal = myVal + 1 %}
								<option value="{{ items.id }}">
									{% if myVal == 1 %}Version actuelle —
									{% else %}
										Version du
									{% endif %}
									{{ items.created|date('d/m/y - H:i:s', "Europe/Paris") }}
								</option>
							{% endfor %}
						</select>
					</div>
				</div>
			</div>
		</div>
	</div><input type="hidden" value="{{ infoPub.id }}" id="hideIdPub"/><input type="hidden" id="hideIdChap" value="{{ infoChap.id }}" id="hideId"/><input type="hidden" id="hidePubStatus" value="{{ infoPub.status }}" id="hideId"/><input type="hidden" id="hideChapStatus" value="{{ infoChap.status }}" id="hideId"/>
{% endblock %}
