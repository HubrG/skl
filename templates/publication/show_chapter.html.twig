{% extends 'base.html.twig' %}

{% block title %}
	{{ infoPub.title ~ ' (' ~ infoChap.title ~ ')' }}
	-
	{{ parent() }}
{% endblock %}
{% block body %}
	<section class="col-span-6 col-start-4  row-start-1 gap-10 grayscale">
		<h1 class="text-center font-serif text-xl">
			<a href="{{ path("app_publication_show_one", {id:infoPub.id, slug:infoPub.slug}) }}">{{ infoPub.title }}</a>
		</h1>
		<h2 class="text-center -mt-8 text-xs">
			<small>par</small>
			<span class="font-medium">
				<a href="{{ path("app_user", {username:infoPub.user.username}) }}">{{ infoPub.user.nickname }}</a>
			</span>
		</h2>
	</section>
	<section class="col-span-8 col-start-3 pt-10 row-start-2" id="chapContent">
		{% if previousChap %}
			<div class="fixed top-0 w-10 bottom-0 left-0 flex items-center justify-start  ml-8 lg:ml-56 z-10" id="arrowPrevious">
				<a href="{{ path("app_chapter_show", {idChap:previousChap.id, slugPub:infoPub.slug, user:infoPub.user.username, slug:previousChap.slug}) }}" class="text-slate-600">
					<i class="fa-solid fa-angles-left text-4xl"></i>
				</a>
			</div>
		{% endif %}
		<turbo-frame id="chapContentTurbo">
			<article class="flex flex-col justify-center">
				{{ infoChap.content|raw }}
			</article>
		</turbo-frame>
		{% if nextChap %}
			<div class="fixed top-0 bottom-0 right-0 flex items-center justify-end mr-8 lg:mr-56  z-10" id="arrowNext">
				<a href="{{ path("app_chapter_show", {idChap:nextChap.id, slugPub:infoPub.slug, user:infoPub.user.username, slug:nextChap.slug}) }}" class="text-slate-600">
					<i class="fa-solid fa-angles-right  text-4xl"></i>
				</a>
			</div>
		{% endif %}
		<div class="mt-10" id="bottomChap">
			{% if previousChap %}
				<p class="float-left">
					<a href="{{ path("app_chapter_show", {idChap:previousChap.id, slugPub:infoPub.slug, user:infoPub.user.username, slug:previousChap.slug}) }}">
						<i class="fa-solid fa-angles-left"></i>
						Chapitre précédent</a>
				</p>
			{% endif %}
			{% if nextChap %}
				<p class="float-right">
					<a href="{{ path("app_chapter_show", {idChap:nextChap.id, slugPub:infoPub.slug, user:infoPub.user.username, slug:nextChap.slug}) }}">Chapitre suivant
						<i class="fa-solid fa-angles-right"></i>
					</a>
				</p>
			{% endif %}
		</div>
	</section>
	{# TODO: ajouter temps de lecture restant dans le chapitre + temps de lecture total de la publication #}
	<section class="col-span-8 col-start-3  mt-5 w-full row-start-3">
		<hr class="mb-5"/>
		<h3 class="text-2xl font-medium">Commentaires</h3>
		{{ form_start(form, {attr:{"data-turbo-frame":"commentFrame"}}) }}
		<div class="flex items-center">
			{{ form_widget(form.content, {attr:{"class":"h-[3.4rem] items-center content-center pt-3"}}) }}
			<button type="submit" class="btn btn-primary h-12" id="sendComment">Envoyer</button>
		</div>
		{{ form_end(form) }}
		<hr>
		<turbo-frame id="commentFrame">
			<p>{{ infoChap.publicationChapterComments|length }}
				commentaire(s)<br/><br/>
			</p>
			{% set n = 0 %}
			{% if app.user.id is defined %}
				{% set userLogId = app.user.id %}
			{% else %}
				{% set userLogId = null %}
			{% endif %}
			{% for item in comments|sort((a, b) => a.publishDate > b.publishDate ? -1 : 1) %}
				<div {% if n == 0 and userLogId == item.user.id and item.publishDate > "now"|date_modify("-2 seconds") %} id="lastComment" class="bg-slate-50 text-slate-600  animate__animated animate__fadeIn p-2 rounded transition-colors duration-[1000ms]" {% else %} class=" block  p-2 rounded" {% endif %}>
					<p class=" text-lg">
						<small>il y a
							{{ item.publishDate|since }}
							par
							<a href="{{ path("app_user", {username:item.user.username}) }}">{{ item.user.nickname }}</a>
							{% if item.user.id == userLogId %}
								|
								<a data-turbo-frame="_self" href="{{ path("app_chapter_del_comment", {id:item.id}) }}">Supprimer</a>
								|
								<button type="button" class="updateButton" id="updateButton-{{ item.id }}">Modifier</button>
								{% set class = "fa-regular fa-heart " %}
							{% elseif userLogId %}
								{% set class = "fa-regular fa-heart likeButton cursor-pointer" %}
							{% else %}
								{% set class = "fa-regular fa-heart " %}
							{% endif %}
							|
							{% for itemLike in item.publicationChapterCommentLikes %}
								{% if itemLike.user.id == userLogId %}
									{% set class = "fa-solid fa-heart text-red-500 cursor-pointer likeButton" %}
								{% else %}
									{% set class = "fa-regular fa-heart" %}
								{% endif %}
							{% endfor %}
							<i class="{{ class }} animate__animated" id="likeButton-{{ item.id }}"></i>
							<span id="nbLikes-{{ item.id }}">{{ item.publicationChapterCommentLikes|length }}</span>
						</small>
					</p>
					<div id="updateCom-{{ item.id }}">
						<p id="comShow-{{ item.id }}">{{ item.content|nl2br }}</p>
					</div>
				</div>
				{% set n = n + 1 %}
			{% endfor %}
			{% if nbrShowCom < infoChap.publicationChapterComments|length %}
				{% if infoPub.slug %}
					{% set chapterSlug = infoPub.slug %}
				{% else %}
					{% set chapterSlug = "feuille-n0" ~ (chapter.orderDisplay + 1) %}
				{% endif %}
				<a href="{{path("app_chapter_show", {user:infoPub.user.id, slug:chapterSlug, slugPub:infoPub.slug, idChap:infoChap.id, nbrShowCom:nbrShowCom + 10})}}">Afficher plus de commentaires</a>
			{% endif %}
		</turbo-frame>
	</section>
{% endblock %}
